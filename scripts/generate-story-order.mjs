import { readdirSync, readFileSync, writeFileSync } from "node:fs";
import { join, relative, resolve } from "node:path";

// Find all .stories.tsx files in src/views
const findStoryFiles = (dir) => {
  const files = [];
  try {
    const entries = readdirSync(dir, { withFileTypes: true });
    for (const entry of entries) {
      const fullPath = join(dir, entry.name);
      if (entry.isDirectory()) {
        files.push(...findStoryFiles(fullPath));
      } else if (entry.isFile() && entry.name.endsWith(".stories.tsx")) {
        files.push(fullPath);
      }
    }
  } catch {
    // Ignore errors
  }
  return files;
};

const viewsDir = resolve(process.cwd(), "src/views");
const storyFiles = findStoryFiles(viewsDir);

if (storyFiles.length === 0) {
  console.error("‚ùå No story files found in src/views");
  process.exit(1);
}

console.log(`üìö Found ${storyFiles.length} story file(s)`);

// Process all story files and build a single object
const storyOrders = {};
const sources = [];

for (const storiesFile of storyFiles) {
  const source = readFileSync(storiesFile, "utf-8");

  // Match all export const declarations: export const StoryName: Story = ...
  const exportMatches = Array.from(
    source.matchAll(/export\s+const\s+(\w+)\s*:\s*Story\s*=/g),
  );

  const order = exportMatches.map((match) => match[1]);

  if (order.length === 0) {
    console.warn(`‚ö†Ô∏è  No stories found in ${relative(process.cwd(), storiesFile)}`);
    continue;
  }

  // Extract view name from the story file location
  const relativePath = relative(viewsDir, storiesFile);
  const viewName = relativePath.split("/")[0];

  storyOrders[viewName] = order;
  sources.push(`//   ${viewName}: ${relative(process.cwd(), storiesFile)}`);

  console.log(`‚úÖ Processed ${viewName}: ${order.join(", ")}`);
}

// Generate single output file
const outputFile = resolve(process.cwd(), "src/remotion/utils/story-orders.ts");

const content = `// This file is auto-generated by scripts/generate-story-order.mjs
// Do not edit manually - run: pnpm run generate-story-order
//
// Sources:
${sources.join("\n")}

export const STORY_ORDERS = ${JSON.stringify(storyOrders, null, 2)} as const;
`;

writeFileSync(outputFile, content, "utf-8");
console.log(`\n‚ú® Generated ${outputFile} with ${Object.keys(storyOrders).length} view(s)`);
